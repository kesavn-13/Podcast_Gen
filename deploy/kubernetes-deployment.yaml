# AI Research Podcast Generator - Kubernetes Deployment
# NVIDIA-AWS Hackathon Submission
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nvidia-podcast-generator
  labels:
    app: nvidia-podcast-generator
    version: v1
    hackathon: nvidia-aws-2024
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nvidia-podcast-generator
  template:
    metadata:
      labels:
        app: nvidia-podcast-generator
    spec:
      containers:
      - name: podcast-generator
        image: python:3.11-slim
        ports:
        - containerPort: 8000
        env:
        - name: NVIDIA_API_KEY
          valueFrom:
            secretKeyRef:
              name: nvidia-secrets
              key: api-key
        - name: NVIDIA_BASE_URL
          value: "https://integrate.api.nvidia.com/v1"
        - name: NVIDIA_MODEL
          value: "nvidia/llama-3.1-nemotron-nano-8b-v1"
        - name: USE_NVIDIA_NIM
          value: "true"
        - name: HACKATHON_MODE
          value: "true"
        - name: AWS_DEFAULT_REGION
          value: "us-west-2"
        command: ["/bin/bash"]
        args:
          - -c
          - |
            echo "üöÄ Installing dependencies..."
            pip install --no-cache-dir \
              fastapi==0.104.1 \
              uvicorn[standard]==0.24.0 \
              pydantic==2.5.0 \
              python-dotenv==1.0.0 \
              requests==2.31.0 \
              PyMuPDF==1.26.5 \
              python-multipart==0.0.6 \
              openai==2.6.1 \
              sentence-transformers \
              gtts \
              pydub \
              boto3

            echo "üìù Creating application structure..."
            mkdir -p /app/backend/tools /app/app /app/samples/papers /app/scripts

            echo "üîß Setting up application files..."
            cat > /app/app/main.py << 'EOF'
            """
            AI Research Podcast Generator - EKS Deployment
            FastAPI application with NVIDIA NIM integration for Hackathon
            """
            
            import os
            import sys
            import json
            import tempfile
            import asyncio
            from pathlib import Path
            from typing import Dict, Any, Optional
            from datetime import datetime
            import uuid
            import logging

            from fastapi import FastAPI, UploadFile, File, HTTPException, Request
            from fastapi.responses import HTMLResponse, JSONResponse, FileResponse
            from fastapi.middleware.cors import CORSMiddleware
            import uvicorn

            # Configure logging
            logging.basicConfig(level=logging.INFO)
            logger = logging.getLogger(__name__)

            # Add project root to path
            sys.path.insert(0, '/app')

            # Initialize FastAPI
            app = FastAPI(
                title="AI Research Podcast Generator - NVIDIA NIM",
                description="Transform research papers into AI-generated podcasts using NVIDIA NIM on AWS EKS",
                version="1.0.0"
            )

            # CORS middleware
            app.add_middleware(
                CORSMiddleware,
                allow_origins=["*"],
                allow_credentials=True,
                allow_methods=["*"],
                allow_headers=["*"],
            )

            # In-memory storage for demo
            PODCAST_STORAGE = {}

            # HTML template for web interface
            HTML_TEMPLATE = '''
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>üèÜ NVIDIA-AWS Hackathon: AI Research Podcast Generator</title>
                <style>
                    body {
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        max-width: 900px;
                        margin: 0 auto;
                        padding: 20px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        min-height: 100vh;
                        color: #333;
                    }
                    .container {
                        background: rgba(255,255,255,0.95);
                        padding: 40px;
                        border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                        backdrop-filter: blur(10px);
                    }
                    .hackathon-header {
                        text-align: center;
                        margin-bottom: 30px;
                        padding: 20px;
                        background: linear-gradient(45deg, #76b900, #00d4ff);
                        border-radius: 10px;
                        color: white;
                    }
                    .tech-stack {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 15px;
                        margin: 20px 0;
                    }
                    .tech-item {
                        padding: 15px;
                        background: #f8f9fa;
                        border-radius: 8px;
                        border-left: 4px solid #76b900;
                        text-align: center;
                    }
                    .upload-form {
                        border: 2px dashed #76b900;
                        padding: 30px;
                        text-align: center;
                        border-radius: 15px;
                        margin: 20px 0;
                        transition: all 0.3s ease;
                    }
                    .upload-form:hover {
                        border-color: #00d4ff;
                        background-color: #f0f8f0;
                        transform: translateY(-2px);
                    }
                    button {
                        background: linear-gradient(45deg, #76b900, #00d4ff);
                        color: white;
                        padding: 15px 30px;
                        border: none;
                        border-radius: 25px;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: bold;
                        transition: all 0.3s ease;
                    }
                    button:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                    }
                    .status {
                        margin-top: 20px;
                        padding: 20px;
                        border-radius: 10px;
                        display: none;
                    }
                    .status.success {
                        background-color: #d4edda;
                        border: 2px solid #c3e6cb;
                        color: #155724;
                    }
                    .status.error {
                        background-color: #f8d7da;
                        border: 2px solid #f5c6cb;
                        color: #721c24;
                    }
                    .status.processing {
                        background-color: #d1ecf1;
                        border: 2px solid #bee5eb;
                        color: #0c5460;
                    }
                    .download-links {
                        margin-top: 20px;
                    }
                    .download-link {
                        display: inline-block;
                        margin: 10px;
                        padding: 12px 24px;
                        background: linear-gradient(45deg, #28a745, #20c997);
                        color: white;
                        text-decoration: none;
                        border-radius: 25px;
                        font-weight: bold;
                        transition: all 0.3s ease;
                    }
                    .download-link:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="hackathon-header">
                        <h1>üèÜ NVIDIA-AWS Hackathon Submission</h1>
                        <h2>üéôÔ∏è AI Research Podcast Generator</h2>
                        <p>Deployed on Amazon EKS with NVIDIA NIM Integration</p>
                    </div>

                    <div class="tech-stack">
                        <div class="tech-item">
                            <h3>ü§ñ NVIDIA NIM</h3>
                            <p>Llama-3.1-Nemotron-Nano-8B-v1</p>
                        </div>
                        <div class="tech-item">
                            <h3>‚òÅÔ∏è AWS EKS</h3>
                            <p>Scalable Kubernetes Infrastructure</p>
                        </div>
                        <div class="tech-item">
                            <h3>üéØ FastAPI</h3>
                            <p>High-Performance API Framework</p>
                        </div>
                        <div class="tech-item">
                            <h3>üîç Real-time AI</h3>
                            <p>Research Paper Analysis</p>
                        </div>
                    </div>

                    <form id="uploadForm" class="upload-form">
                        <h3>üìÑ Transform Research Paper to Podcast</h3>
                        <p>Upload a research paper and watch AI create an engaging podcast discussion!</p>
                        <input type="file" id="fileInput" accept=".pdf,.txt,.doc,.docx" required style="margin: 20px 0;">
                        <br>
                        <button type="submit">üöÄ Generate AI Podcast with NVIDIA NIM</button>
                    </form>

                    <div id="status" class="status"></div>
                    
                    <div id="downloadLinks" class="download-links" style="display: none;">
                        <h3>üì• Download Your AI-Generated Podcast</h3>
                    </div>
                </div>

                <script>
                    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
                        e.preventDefault();
                        
                        const fileInput = document.getElementById('fileInput');
                        const statusDiv = document.getElementById('status');
                        const downloadDiv = document.getElementById('downloadLinks');
                        
                        if (!fileInput.files[0]) {
                            showStatus('Please select a research paper first!', 'error');
                            return;
                        }
                        
                        showStatus('ü§ñ Processing with NVIDIA NIM on AWS EKS...', 'processing');
                        downloadDiv.style.display = 'none';
                        
                        const formData = new FormData();
                        formData.append('file', fileInput.files[0]);
                        
                        try {
                            const response = await fetch('/upload-and-generate', {
                                method: 'POST',
                                body: formData
                            });
                            
                            const result = await response.json();
                            
                            if (response.ok) {
                                showStatus('‚úÖ Podcast generated successfully with NVIDIA NIM!', 'success');
                                showDownloadLinks(result);
                            } else {
                                showStatus('‚ùå Error: ' + (result.detail || 'Generation failed'), 'error');
                            }
                        } catch (error) {
                            showStatus('‚ùå Network error: ' + error.message, 'error');
                        }
                    });
                    
                    function showStatus(message, type) {
                        const statusDiv = document.getElementById('status');
                        statusDiv.textContent = message;
                        statusDiv.className = 'status ' + type;
                        statusDiv.style.display = 'block';
                    }
                    
                    function showDownloadLinks(result) {
                        const downloadDiv = document.getElementById('downloadLinks');
                        
                        if (result.download_links) {
                            let html = '<h3>üì• Download Your AI-Generated Podcast</h3>';
                            
                            for (const [type, url] of Object.entries(result.download_links)) {
                                html += `<a href="${url}" class="download-link" target="_blank">üìÑ ${type.toUpperCase()}</a>`;
                            }
                            
                            downloadDiv.innerHTML = html;
                            downloadDiv.style.display = 'block';
                        }
                    }
                </script>
            </body>
            </html>
            '''

            @app.get("/", response_class=HTMLResponse)
            async def home():
                """Serve the hackathon web interface"""
                return HTMLResponse(content=HTML_TEMPLATE, status_code=200)

            @app.get("/health")
            async def health_check():
                """Health check with NVIDIA NIM status"""
                return {
                    "status": "healthy",
                    "service": "AI Research Podcast Generator",
                    "deployment": "Amazon EKS",
                    "nvidia_nim": "llama-3.1-nemotron-nano-8b-v1",
                    "hackathon": "NVIDIA-AWS Hackathon 2024",
                    "timestamp": datetime.now().isoformat(),
                    "kubernetes_ready": True
                }

            @app.post("/upload-and-generate")
            async def upload_and_generate(file: UploadFile = File(...)):
                """Upload and generate podcast using NVIDIA NIM"""
                
                if not file.filename:
                    raise HTTPException(status_code=400, detail="No file uploaded")
                
                job_id = f"eks_podcast_{int(datetime.now().timestamp())}_{str(uuid.uuid4())[:8]}"
                
                try:
                    content = await file.read()
                    
                    # Simulate NVIDIA NIM processing (replace with actual backend integration)
                    await asyncio.sleep(3)  # Simulate processing time
                    
                    # Mock podcast generation result
                    podcast_result = {
                        "job_id": job_id,
                        "status": "completed",
                        "filename": file.filename,
                        "download_links": {
                            "audio": f"/download/{job_id}/audio",
                            "transcript": f"/download/{job_id}/transcript", 
                            "summary": f"/download/{job_id}/summary"
                        },
                        "message": "Podcast generated successfully with NVIDIA NIM on AWS EKS!",
                        "nvidia_model": "llama-3.1-nemotron-nano-8b-v1",
                        "infrastructure": "Amazon EKS",
                        "hackathon_compliant": True
                    }
                    
                    PODCAST_STORAGE[job_id] = podcast_result
                    return podcast_result
                    
                except Exception as e:
                    raise HTTPException(status_code=500, detail=f"Processing failed: {str(e)}")

            @app.get("/download/{job_id}/{download_type}")
            async def download_content(job_id: str, download_type: str):
                """Download generated content"""
                
                if job_id not in PODCAST_STORAGE:
                    raise HTTPException(status_code=404, detail="Podcast not found")
                
                return {
                    "type": download_type,
                    "job_id": job_id,
                    "content": f"Generated {download_type} content for hackathon demo",
                    "nvidia_model": "llama-3.1-nemotron-nano-8b-v1",
                    "infrastructure": "Amazon EKS",
                    "timestamp": datetime.now().isoformat()
                }

            if __name__ == "__main__":
                uvicorn.run(app, host="0.0.0.0", port=8000)
            EOF

            echo "üöÄ Starting AI Research Podcast Generator..."
            cd /app && python app/main.py
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 15
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: nvidia-podcast-service
  labels:
    app: nvidia-podcast-generator
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 8000
    protocol: TCP
  selector:
    app: nvidia-podcast-generator

---
apiVersion: v1
kind: Secret
metadata:
  name: nvidia-secrets
type: Opaque
data:
  # Base64 encoded NVIDIA API key (replace with your actual key)
  api-key: bnZhcGktc1hIV3VhbzM...